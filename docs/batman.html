<!DOCTYPE html>  <html> <head>   <title>batman.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               batman.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Batman.js</p>

<p>Created by Nicholas Small</p>

<p>Copyright 2011, JadedPixel Technologies, Inc.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The global namespace, the <code>Batman</code> function will also create also create a new
instance of Batman.Object and mixin all arguments to it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman = </span><span class="nf">(mixins...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span> <span class="nx">mixins</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Global Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>$typeOf</code> returns a string that contains the built-in class of an object
like <code>String</code>, <code>Array</code>, or <code>Object</code>. Note that only <code>Object</code> will be returned for
the entire prototype chain.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.typeOf = $typeOf = </span><span class="nf">(object) -&gt;</span>
  <span class="nx">_objectToString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Cache this function to skip property lookups.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_objectToString = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>$mixin</code> applies every key from every argument after the first to the
first argument. If a mixin has an <code>initialize</code> method, it will be called in
the context of the <code>to</code> object, and it's key/values won't be applied.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.mixin = $mixin = </span><span class="nf">(to, mixins...) -&gt;</span>
  <span class="nv">set = </span><span class="nx">to</span><span class="p">.</span><span class="nx">set</span>
  <span class="nv">hasSet = </span><span class="k">typeof</span> <span class="nx">set</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  
  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">continue</span> <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">mixin</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;Object&#39;</span>
    
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">,</span> <span class="s1">&#39;prototype&#39;</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">hasSet</span> <span class="k">then</span> <span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">to</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  
  <span class="nx">to</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>$unmixin</code> removes every key/value from every argument after the first
from the first argument. If a mixin has a <code>deinitialize</code> method, it will be
called in the context of the <code>from</code> object and won't be removed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.unmixin = $unmixin = </span><span class="nf">(from, mixins...) -&gt;</span>
  <span class="k">for</span> <span class="nx">mixin</span> <span class="k">in</span> <span class="nx">mixins</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">mixin</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">,</span> <span class="s1">&#39;uninitialize&#39;</span><span class="p">]</span>
      
      <span class="nx">from</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="k">delete</span> <span class="nx">from</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">mixin</span><span class="p">.</span><span class="nx">deinitialize</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">mixin</span><span class="p">.</span><span class="nx">deinitialize</span><span class="p">.</span><span class="nx">call</span> <span class="nx">from</span>
  
  <span class="nx">from</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>$block</code> takes in a function and returns a function which can either
  A) take a callback as its last argument as it would normally, or 
  B) accept a callback as a second function application.
This is useful so that multiline functions can be passed as callbacks 
without the need for wrapping brackets (which a CoffeeScript bug 
requires them to have).</p>

<p>Example:
 With a function that accepts a callback as its last argument</p>

<pre><code>f = (a, b, callback) -&gt; callback(a + b)
ex = $block f
</code></pre>

<p>We can use $block to make it accept the callback in both ways:   </p>

<pre><code>ex(2, 3, (x) -&gt; alert(x))  # alerts 5
</code></pre>

<p>or</p>

<pre><code>ex(2, 3) (x) -&gt; alert(x)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._block = $block = </span><span class="nf">(fn) -&gt;</span>
  <span class="nv">callbackEater = </span><span class="nf">(args...) -&gt;</span>
    <span class="nv">ctx = </span><span class="err">@</span>
    <span class="nv">f = </span><span class="nf">(callback) -&gt;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">callback</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">f</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span>
    <span class="k">else</span>
      <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>findName</code> allows an anonymous function to find out what key it resides
in within a context.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman._findName = $findName = </span><span class="nf">(f, context) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">context</span>
      <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">f</span>
        <span class="nv">f.displayName = </span><span class="nx">key</span>
        <span class="k">break</span>
  
  <span class="nx">f</span><span class="p">.</span><span class="nx">displayName</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="vi">@defaultAccessor:</span>
    <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
    <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="k">delete</span> <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">return</span>
  <span class="vi">@triggerTracker: </span><span class="kc">null</span>
  <span class="vi">@for: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">_batman</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">base</span>
      <span class="nv">properties = </span><span class="nx">base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">properties</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">properties</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">or</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="vi">@base = </span><span class="nx">base</span>
    <span class="vi">@key = </span><span class="nx">key</span>
  <span class="nv">isProperty: </span><span class="kc">true</span>
  <span class="nv">accessor: </span><span class="o">-&gt;</span>
    <span class="nv">key = </span><span class="nx">@key</span>
    <span class="nv">accessors = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;keyAccessors&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">accessors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">val = </span><span class="nx">accessors</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">val</span> 
    <span class="k">else</span>
      <span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">getFirst</span><span class="p">(</span><span class="s1">&#39;defaultAccessor&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span>

  <span class="nv">registerAsTrigger: </span><span class="o">-&gt;</span>
    <span class="nx">tracker</span><span class="p">.</span><span class="nx">add</span> <span class="err">@</span> <span class="k">if</span> <span class="nv">tracker = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span>
  <span class="nv">getValue: </span><span class="o">-&gt;</span>
    <span class="nx">@registerAsTrigger</span><span class="p">()</span>
    <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span>
    <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">val</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span> <span class="nx">@accessor</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">unset</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@key</span>
  <span class="nv">isEqual: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">@constructor</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">and</span> <span class="nx">@base</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">base</span> <span class="o">and</span> <span class="nx">@key</span> <span class="o">is</span> <span class="nx">other</span><span class="p">.</span><span class="nx">key</span>
    

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ObservableProperty</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">super</span>
    <span class="vi">@observers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
    <span class="vi">@_preventCount = </span><span class="mi">0</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span>
    <span class="nx">@cacheDependentValues</span><span class="p">()</span>
    <span class="k">super</span>
    <span class="nx">@fireDependents</span><span class="p">()</span>
    <span class="nx">val</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span>
    <span class="nx">@cacheDependentValues</span><span class="p">()</span>
    <span class="k">super</span>
    <span class="nx">@fireDependents</span><span class="p">()</span>
    <span class="k">return</span>
  <span class="nv">cacheDependentValues: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@dependents</span>
      <span class="nx">@dependents</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(prop) -&gt;</span> <span class="nv">prop.cachedValue = </span><span class="nx">prop</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">fireDependents: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@dependents</span>
      <span class="nx">@dependents</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(prop) -&gt;</span>
        <span class="nx">prop</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(),</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">cachedValue</span><span class="p">)</span> <span class="k">if</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">hasObserversToFire</span><span class="o">?</span><span class="p">()</span>
  <span class="nv">observe: </span><span class="nf">(fireImmediately..., callback) -&gt;</span>
    <span class="nv">fireImmediately = </span><span class="nx">fireImmediately</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="kc">true</span>
    <span class="nv">currentValue = </span><span class="nx">@getValue</span><span class="p">()</span>
    <span class="nx">@observers</span><span class="p">.</span><span class="nx">add</span> <span class="nx">callback</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span>
    <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@base</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">,</span> <span class="nx">currentValue</span><span class="p">)</span> <span class="k">if</span> <span class="nx">fireImmediately</span>
    <span class="err">@</span>
  <span class="nv">hasObserversToFire: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@observers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@base</span> <span class="o">is</span> <span class="vi">@base.constructor::</span>
    <span class="nx">@base</span><span class="p">.</span><span class="nx">constructor</span><span class="o">::</span><span class="nx">property</span><span class="o">?</span><span class="p">(</span><span class="nx">@key</span><span class="p">).</span><span class="nx">observers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">preventFire: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span><span class="o">++</span>
  <span class="nv">allowFire: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span><span class="o">--</span> <span class="k">if</span> <span class="nx">@_preventCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">isAllowedToFire: </span><span class="o">-&gt;</span> <span class="nx">@_preventCount</span> <span class="o">&lt;=</span> <span class="mi">0</span>
  <span class="nv">fire: </span><span class="nf">(args...) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
    <span class="nv">key = </span><span class="nx">@key</span>
    <span class="nv">base = </span><span class="nx">@base</span>
    <span class="nv">observers = </span><span class="p">[</span><span class="nx">@observers</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@base</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">property</span><span class="o">?</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">observers</span><span class="p">)).</span><span class="nx">reduce</span><span class="p">(</span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="nx">observers</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(callback) -&gt;</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nx">@refreshTriggers</span><span class="p">()</span>
  <span class="nv">forget: </span><span class="nf">(observer) -&gt;</span>
    <span class="k">if</span> <span class="nx">observer</span>
      <span class="nx">@observers</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@observers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@clearTriggers</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@hasObserversToFire</span><span class="p">()</span>
  <span class="nv">refreshTriggers: </span><span class="o">-&gt;</span>
    <span class="nv">Batman.Property.triggerTracker = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
    <span class="nx">@getValue</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@triggers</span>
      <span class="nx">@triggers</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span>
          <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="o">?</span><span class="p">.</span><span class="nx">remove</span> <span class="err">@</span>
    <span class="vi">@triggers = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">triggerTracker</span>
    <span class="nx">@triggers</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="p">.</span><span class="nx">add</span> <span class="err">@</span>
    <span class="nv">Batman.Property.triggerTracker = </span><span class="kc">null</span>
  <span class="nv">clearTriggers: </span><span class="o">-&gt;</span>
    <span class="nx">@triggers</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">property</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">property</span><span class="p">.</span><span class="nx">dependents</span><span class="p">.</span><span class="nx">remove</span> <span class="err">@</span>
    <span class="vi">@triggers = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Keypaths</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ObservableProperty</span>
  <span class="nv">constructor: </span><span class="nf">(base, key) -&gt;</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="vi">@segments = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
      <span class="vi">@depth = </span><span class="nx">@segments</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">else</span>
      <span class="vi">@segments = </span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="vi">@depth = </span><span class="mi">1</span>
    <span class="k">super</span>
  <span class="nv">slice: </span><span class="nf">(begin, end) -&gt;</span>
    <span class="nv">base = </span><span class="nx">@base</span>
    <span class="k">for</span> <span class="nx">segment</span> <span class="k">in</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">begin</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">base</span><span class="o">?</span> <span class="o">and</span> <span class="nv">base = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">segment</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="k">for</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">@segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span> <span class="nx">end</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
  <span class="nv">terminalProperty: </span><span class="o">-&gt;</span> <span class="nx">@slice</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nv">getValue: </span><span class="o">-&gt;</span>
    <span class="nx">@registerAsTrigger</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">setValue: </span><span class="nf">(val) -&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unsetValue: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">@depth</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">super</span> <span class="k">else</span> <span class="nx">@terminalProperty</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">unsetValue</span><span class="p">()</span>
 </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Observable</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Batman.Observable is a generic mixin that can be applied to any object to allow it to be bound to.
It is applied by default to every instance of <code>Batman.Object</code> and subclasses.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Observable =</span>
  <span class="nv">isObservable: </span><span class="kc">true</span>
  <span class="nv">property: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">Keypath</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span> <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">getValue</span><span class="p">()</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span> <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span> <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">unsetValue</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Pass a key and a callback. Whenever the value for that key changes, your
callback will be called in the context of the original object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">observe: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">observe</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
    <span class="err">@</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Tell any observers attached to a key to fire, manually. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fire: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">fire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Forget removes an observer from an object. If the callback is passed in, 
its removed. If no callback but a key is passed in, all the observers on
that key are removed. If no key is passed in, all observers are removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">forget: </span><span class="nf">(key, observer) -&gt;</span>
    <span class="k">if</span> <span class="nx">key</span>
      <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">forget</span><span class="p">(</span><span class="nx">observer</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(key, property) -&gt;</span> <span class="nx">property</span><span class="p">.</span><span class="nx">forget</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Prevent allows the prevention of a given binding from firing. Prevent counts can be nested,
so three calls to prevent means three calls to allow must be made before observers will
be fired.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prevent: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">preventFire</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Allow unblocks a property for firing observers. Every call to prevent
must have a matching call to allow later if observers are to be fired.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allow: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">allowFire</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>allowed returns a boolean describing whether or not the key is 
currently allowed to fire its observers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allowed: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@property</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">isAllowedToFire</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Events</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>Batman.EventEmitter</code> is another generic mixin that simply allows an object to 
emit events. Batman events use observers to manage the callbacks, so they require that
the object emitting the events be observable. If events need to be attached to an object
which isn't a <code>Batman.Object</code> or doesn't have the <code>Batman.Observable</code> and <code>Batman.EventEmitter</code>
mixins applied, the $event function can be used to create ephemeral event objects which
use those mixins internally.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.EventEmitter =</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>An event is a convenient observer wrapper. Any function can be wrapped in an event, and
when called, it will cause it's object to fire all the observers for that event. There is 
also some syntactical sugar so observers can be registered simply by calling the event with a 
function argument. Notice that the <code>$block</code> helper is used here so events can be declared in
class definitions using the second function application syntax and no wrapping brackets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">event: </span><span class="nx">$block</span> <span class="nf">(key, context, callback) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">context</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nv">callback = </span><span class="nx">context</span>
      <span class="nv">context = </span><span class="kc">null</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span> <span class="o">and</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;String&#39;</span>
      <span class="nv">callback = </span><span class="nx">key</span>
      <span class="nv">key = </span><span class="kc">null</span>
    </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Return a function which either takes another observer
to register or a value to fire the event with.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="nf">(observer) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@observe</span>
        <span class="k">throw</span> <span class="s2">&quot;EventEmitter requires Observable&quot;</span>
      
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
      
      <span class="nx">key</span> <span class="o">||=</span> <span class="nx">$findName</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
      <span class="nv">fired = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">_oneShotFired</span><span class="o">?</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Pass a function to the event to register it as an observer.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">observer</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
        <span class="nx">@observe</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">observer</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">_firedArgs</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span> <span class="o">and</span> <span class="nx">fired</span>
      </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Otherwise, calling the event will cause it to fire. Any
arguments you pass will be passed to your wrapped function.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nx">@allowed</span> <span class="nx">key</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span> <span class="o">and</span> <span class="nx">fired</span>
        <span class="nv">value = </span><span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
        </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Observers will only fire if the result of the event is not false.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Get and cache the arguments for the event listeners. Add the value if 
its not undefined, and then concat any more arguments passed to this 
event when fired.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">f._firedArgs = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
              <span class="p">[</span><span class="nx">value</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">arguments</span><span class="p">...</span>
            <span class="k">else</span>
              <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">[]</span>
              <span class="k">else</span>
                <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Copy the array and add in the key for <code>fire</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">args = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">f</span><span class="p">.</span><span class="nx">_firedArgs</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">key</span>
          <span class="nx">@fire</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
          
          <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isOneShot</span>
            <span class="nv">firings = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">_oneShotFired</span> <span class="o">||=</span> <span class="p">{}</span>
            <span class="nx">firings</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">yes</span>
        
        <span class="nx">value</span>
      <span class="k">else</span>
        <span class="kc">false</span>
    </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>This could be its own mixin but is kept here for brevity.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="nx">f</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="k">if</span> <span class="nx">context</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span> <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
    <span class="nx">$mixin</span> <span class="nx">f</span><span class="p">,</span>
      <span class="nv">isEvent: </span><span class="kc">yes</span>
      <span class="nv">action: </span><span class="nx">callback</span>
      <span class="nv">isOneShot: </span><span class="nx">@isOneShot</span>
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>One shot events can be used for something that only fires once. Any observers
added after it has already fired will simply be executed immediately. This is useful
for things like <code>ready</code> events on requests or renders, because once ready they always
remain ready. If an AJAX request had a vanilla <code>ready</code> event, observers attached after
the ready event fired the first time would never fire, as they would be waiting for
the next time <code>ready</code> would fire as is standard with vanilla events. With a one shot
event, any observers attached after the first fire will fire immediately, meaning no logic</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">eventOneShot: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
      <span class="nv">isOneShot: </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><code>$event</code> lets you create an ephemeral event without needing an EventEmitter.
If you already have an EventEmitter object, you should call .event() on it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$event = </span><span class="nf">(callback) -&gt;</span>
  <span class="nv">context = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">event</span><span class="p">(</span><span class="s1">&#39;_event&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><code>$eventOneShot</code> lets you create an ephemeral one-shot event without needing an EventEmitter.
If you already have an EventEmitter object, you should call .eventOneShot() on it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$eventOneShot = </span><span class="nf">(callback) -&gt;</span>
  <span class="nv">context = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">eventOneShot</span><span class="p">(</span><span class="s1">&#39;_event&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h1>#</h1>

<p>Batman.StateMachine</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.StateMachine = </span><span class="p">{</span>
  <span class="nv">initialize: </span><span class="o">-&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">states</span>
      <span class="vi">@_batman.states = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@accessor</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@state</span><span class="p">()</span>
        <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span> <span class="nx">_stateMachine_setState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  
  <span class="nv">state: </span><span class="nf">(name, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    
    <span class="k">if</span> <span class="o">not</span> <span class="nx">name</span>
      <span class="k">return</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getFirst</span> <span class="s1">&#39;state&#39;</span>
    
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@event</span>
      <span class="k">throw</span> <span class="s2">&quot;StateMachine requires EventEmitter&quot;</span>
    
    <span class="nv">event = </span><span class="err">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">@event</span> <span class="nx">name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">_stateMachine_setState</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span> <span class="kc">false</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">callback</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">event</span>
  
  <span class="nv">transition: </span><span class="nf">(from, to, callback) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    
    <span class="nx">@state</span> <span class="nx">from</span>
    <span class="nx">@state</span> <span class="nx">to</span>
    
    <span class="nv">name = </span><span class="s2">&quot;#{from}-&gt;#{to}&quot;</span>
    <span class="nv">transitions = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">states</span>
    
    <span class="nv">event = </span><span class="nx">transitions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="nx">transitions</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">$event</span> <span class="o">-&gt;</span><span class="p">)</span>
    <span class="nx">event</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>
    <span class="nx">event</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>this is cached here so it doesn't need to be recompiled for every setter</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_stateMachine_setState = </span><span class="nf">(newState) -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
  
  <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">isTransitioning</span>
    <span class="p">(</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span> <span class="o">||=</span> <span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>
  
  <span class="vi">@_batman.isTransitioning = </span><span class="kc">yes</span>
  
  <span class="nv">oldState = </span><span class="nx">@state</span><span class="p">()</span>
  <span class="vi">@_batman.state = </span><span class="nx">newState</span>
  
  <span class="k">if</span> <span class="nx">newState</span> <span class="o">and</span> <span class="nx">oldState</span>
    <span class="nv">name = </span><span class="s2">&quot;#{oldState}-&gt;#{newState}&quot;</span>
    <span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;states&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">event</span>
        <span class="nx">event</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span>
  
  <span class="k">if</span> <span class="nx">newState</span>
    <span class="nx">@fire</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">oldState</span>
  
  <span class="vi">@_batman.isTransitioning = </span><span class="kc">no</span>
  <span class="err">@</span><span class="p">[</span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="p">.</span><span class="nx">shift</span><span class="p">()]()</span> <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">nextState</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
  
  <span class="nx">newState</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h2>Objects</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.initializeObject = </span><span class="nf">(object) -&gt;</span>
  <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">object</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>

<span class="nv">Batman._Batman = </span><span class="k">class</span> <span class="nx">_Batman</span>
  <span class="nv">constructor: </span><span class="nf">(@object, mixins...) -&gt;</span>
    <span class="nx">$mixin</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">mixins</span><span class="p">...)</span> <span class="k">if</span> <span class="nx">mixins</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p><code>Batman.initializeObject</code> is called by all the methods in Batman.Object to ensure that the
objects <code>_batman</code> property is initialized and it's own. Classes extending Batman.Object inherit
methods like <code>get</code>, <code>set</code>, and <code>observe</code> by default on the class and prototype levels, such that
both instances and the class respond to them and can be bound to. However, CoffeeScript's static
class inheritance copies over all class level properties indiscriminately, so a parent class' 
<code>_batman</code> object will get copied to its subclasses, transferring all the information stored there and 
allowing subclasses to mutate parent state. This method prevents this undesirable behaviour by tracking
which object the <code>_batman_</code> object was initialized upon, and reinitializing if that has changed since
initialization.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check: </span><span class="nf">(object) -&gt;</span>
    <span class="k">if</span> <span class="nx">object</span> <span class="o">!=</span> <span class="nx">@object</span>
      <span class="nv">object._batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>

  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">switch</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">when</span> <span class="mi">0</span> 
        <span class="kc">undefined</span>
      <span class="k">when</span> <span class="mi">1</span>
        <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">merge</span><span class="o">?</span>
          <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
        <span class="nx">results</span>
  
  <span class="nv">getFirst: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">results = </span><span class="nx">@getAll</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">getAll: </span><span class="nf">(keyOrGetter) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">keyOrGetter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">getter = </span><span class="nx">keyOrGetter</span>
    <span class="k">else</span>
      <span class="nv">getter = </span><span class="nf">(ancestor) -&gt;</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span><span class="p">[</span><span class="nx">keyOrGetter</span><span class="p">]</span>

    <span class="nv">results = </span><span class="nx">@ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span>
    <span class="k">if</span> <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">@object</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">val</span>
    <span class="nx">results</span>

  <span class="nv">ancestors: </span><span class="p">(</span><span class="nv">getter = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Decide if the object is a class or not, and pull out the first ancestor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isClass = </span><span class="o">!!</span><span class="nx">@object</span><span class="p">.</span><span class="nx">prototype</span>
    <span class="nv">parent = </span><span class="k">if</span> <span class="nx">isClass</span> 
      <span class="nx">@object</span><span class="p">.</span><span class="nx">__super__</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span> 
    <span class="k">else</span> 
      <span class="k">if</span> <span class="p">(</span><span class="nv">cons = </span><span class="nx">@object</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)</span><span class="o">::</span> <span class="o">==</span> <span class="nx">@object</span>
        <span class="nx">cons</span><span class="p">.</span><span class="nx">__super__</span>
      <span class="k">else</span>
        <span class="nv">cons::</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Call _batman.get on the ancestor which will take the next step up the chain</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">parent</span><span class="o">?</span>
      <span class="nv">val = </span><span class="nx">getter</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span>
      <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="k">if</span> <span class="nx">val</span><span class="o">?</span>
      <span class="nv">results = </span><span class="nx">results</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">(</span><span class="nx">getter</span><span class="p">)</span> <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_batman</span><span class="o">?</span>
    <span class="nx">results</span>

  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><code>Batman.Object</code> is the base class for all other Batman objects. It is not abstract. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Setting <code>isGlobal</code> to true will cause the class name to be defined on the
global object. For example, Batman.Model will be aliased to window.Model.
This should be used sparingly; it's mostly useful for debugging.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@global: </span><span class="nf">(isGlobal) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">isGlobal</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="nx">container</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span>
  </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Apply mixins to this subclass.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@mixin: </span><span class="nf">(mixins...) -&gt;</span> <span class="nx">$mixin</span> <span class="err">@</span><span class="p">,</span> <span class="nx">mixins</span><span class="p">...</span>
  </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Apply mixins to instances of this subclass.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mixin: </span><span class="nx">@mixin</span>
  
  <span class="vi">@accessor: </span><span class="nf">(keys..., accessor) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">accessor</span><span class="p">.</span><span class="nx">get</span> <span class="o">or</span> <span class="nx">accessor</span><span class="p">.</span><span class="nx">set</span>
        <span class="vi">@_batman.defaultAccessor = </span><span class="nx">accessor</span>
      <span class="k">else</span>
        <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">accessor</span>
          <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">{</span><span class="nv">get: </span><span class="nx">value</span><span class="p">,</span> <span class="nv">set: </span><span class="nx">value</span><span class="p">})</span>
          <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">else</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
      <span class="nx">@_batman</span><span class="p">.</span><span class="nx">keyAccessors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">accessor</span><span class="p">)</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
  <span class="nv">accessor: </span><span class="nx">@accessor</span>
    
  <span class="nv">constructor: </span><span class="nf">(mixins...) -&gt;</span>
    <span class="vi">@_batman = </span><span class="k">new</span> <span class="nx">_Batman</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="nx">@mixin</span> <span class="nx">mixins</span><span class="p">...</span>
  </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Make every subclass and their instances observable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span>
  <span class="err">@</span><span class="o">::</span><span class="nx">mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">EventEmitter</span>
  

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="p">{}</span>
    <span class="vi">@length = </span><span class="mi">0</span>
  <span class="nv">hasKey: </span><span class="nf">(key) -&gt;</span>
    <span class="k">typeof</span> <span class="nx">@get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span><span class="nx">v</span><span class="p">]</span> <span class="k">in</span> <span class="nx">matches</span>
        <span class="k">return</span> <span class="nx">v</span> <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="nv">set: </span><span class="nf">(key, val) -&gt;</span>
    <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
      <span class="nv">pair = </span><span class="nx">match</span> <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="nx">pair</span>
      <span class="nv">pair = </span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pair</span><span class="p">)</span>
    <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="nv">unset: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nv">matches = </span><span class="nx">@_storage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span><span class="nx">v</span><span class="p">],</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">matches</span>
        <span class="k">if</span> <span class="nx">@equality</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="nx">matches</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">return</span>
  <span class="nv">equality: </span><span class="nf">(lhs, rhs) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">lhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">lhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">rhs</span>
    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">rhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nx">rhs</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">lhs</span>
    <span class="k">else</span>
      <span class="nx">lhs</span> <span class="o">is</span> <span class="nx">rhs</span>
  <span class="nv">each: </span><span class="nf">(iterator) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">values</span> <span class="k">of</span> <span class="nx">@_storage</span>
      <span class="nx">iterator</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">in</span> <span class="nx">values</span>
  <span class="nv">keys: </span><span class="o">-&gt;</span>
    <span class="nv">result = </span><span class="p">[]</span>
    <span class="nx">@each</span> <span class="nf">(obj) -&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
    <span class="nx">result</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="nx">@each</span> <span class="nf">(obj) -&gt;</span> <span class="nx">@unset</span> <span class="nx">obj</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span>
    <span class="nx">@keys</span><span class="p">().</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">hash</span> <span class="k">in</span> <span class="nx">others</span>      
      <span class="nx">hash</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(obj, value) -&gt;</span>
        <span class="nx">merged</span><span class="p">.</span><span class="nx">set</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span>
    <span class="nx">merged</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">accessor</span>
    <span class="nv">get: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">get</span>
    <span class="nv">set: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">set</span>
    <span class="nv">unset: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="nx">unset</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@isEmpty</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;hasKey&#39;</span><span class="p">,</span> <span class="s1">&#39;equality&#39;</span><span class="p">,</span> <span class="s1">&#39;each&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@_storage = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="vi">@length = </span><span class="mi">0</span>
    <span class="nx">@add</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">has: </span><span class="nf">(item) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span> <span class="nx">item</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;unset&#39;</span><span class="p">]</span>
   <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">defaultAccessor</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

  <span class="nv">add: </span><span class="nf">(items...) -&gt;</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
      <span class="nx">unless</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="nx">@_storage</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="kc">true</span>
        <span class="nx">@set</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="nx">@length</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nx">@set</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nx">items</span>
  <span class="nv">remove: </span><span class="nf">(items...) -&gt;</span>
    <span class="nv">results = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
      <span class="k">if</span> <span class="nx">@_storage</span><span class="p">.</span><span class="nx">hasKey</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="nx">@_storage</span><span class="p">.</span><span class="nx">unset</span> <span class="nx">item</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
        <span class="nx">@set</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="nx">@length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nx">@set</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nx">results</span>
  <span class="nv">each: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(key, value) -&gt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="nv">isEmpty: </span><span class="o">-&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">clear: </span><span class="o">-&gt;</span> <span class="nx">@remove</span> <span class="nx">@toArray</span><span class="p">()</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nx">@_storage</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span>

  <span class="nv">merge: </span><span class="nf">(others...) -&gt;</span>
    <span class="nv">merged = </span><span class="k">new</span> <span class="nx">@constructor</span>
    <span class="nx">others</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">set</span> <span class="k">in</span> <span class="nx">others</span>
      <span class="nx">set</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(v) -&gt;</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">add</span> <span class="nx">v</span>
    <span class="nx">merged</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@event</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="s1">&#39;each&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;toArray&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>

  <span class="err">@</span><span class="o">::</span><span class="nx">accessor</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">get: </span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">@isEmpty</span><span class="p">()),</span> <span class="nv">set: </span><span class="o">-&gt;</span><span class="p">}</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SortableSet</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
  <span class="nv">constructor: </span><span class="nf">(index) -&gt;</span>
    <span class="k">super</span>
    <span class="vi">@_indexes = </span><span class="p">{}</span>
    <span class="nx">@addIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
  <span class="nv">add: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="nx">add</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nx">@_reIndex</span><span class="p">()</span>
    <span class="nx">results</span>
  <span class="nv">remove: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
    <span class="nv">results = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span><span class="o">::</span><span class="nx">remove</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nx">@_reIndex</span><span class="p">()</span>
    <span class="nx">results</span>
  <span class="nv">addIndex: </span><span class="nf">(keypath) -&gt;</span>
    <span class="nx">@_reIndex</span><span class="p">(</span><span class="nx">keypath</span><span class="p">)</span>
    <span class="vi">@activeIndex = </span><span class="nx">keypath</span>
  <span class="nv">removeIndex: </span><span class="nf">(keypath) -&gt;</span>
    <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">keypath</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="k">delete</span> <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">keypath</span><span class="p">]</span>
    <span class="nx">keypath</span>
  <span class="nv">each: </span><span class="nf">(iterator) -&gt;</span>
    <span class="nx">iterator</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">toArray</span><span class="p">()</span>
  <span class="nv">toArray: </span><span class="o">-&gt;</span>
    <span class="nv">ary = </span><span class="nx">@_indexes</span><span class="p">[</span><span class="nx">@activeIndex</span><span class="p">]</span> <span class="o">?</span> <span class="nv">ary : </span><span class="k">super</span>
  <span class="nv">_reIndex: </span><span class="nf">(index) -&gt;</span>
    <span class="k">if</span> <span class="nx">index</span>
      <span class="p">[</span><span class="nx">keypath</span><span class="p">,</span> <span class="nx">ordering</span><span class="p">]</span> <span class="o">=</span> <span class="nx">index</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39; &#39;</span>
      <span class="nv">ary = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toArray</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nx">@_indexes</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a,b) -&gt;</span>
        <span class="nv">valueA = </span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">property</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">keypath</span><span class="p">)).</span><span class="nx">getValue</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span>
        <span class="nv">valueB = </span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">property</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">keypath</span><span class="p">)).</span><span class="nx">getValue</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span>
        <span class="p">[</span><span class="nx">valueA</span><span class="p">,</span> <span class="nx">valueB</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">valueB</span><span class="p">,</span> <span class="nx">valueA</span><span class="p">]</span> <span class="k">if</span> <span class="nx">ordering</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;desc&#39;</span>
        <span class="k">if</span> <span class="nx">valueA</span> <span class="o">&lt;</span> <span class="nx">valueB</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">valueA</span> <span class="o">&gt;</span> <span class="nx">valueB</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span>
      <span class="nx">@_reIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="k">for</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">@_indexes</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2>App, Requests, and Routing</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><code>Batman.Request</code> is a normalizer for XHR requests in the Batman world.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">url: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">data: </span><span class="s1">&#39;&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;get&#39;</span>
  
  <span class="nv">response: </span><span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>After the URL gets set, we'll try to automatically send
your request after a short period. If this behavior is
not desired, use @cancel() after setting the URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="err">@</span><span class="o">::</span><span class="nx">observe</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="vi">@_autosendTimeout = </span><span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@send</span><span class="p">()),</span> <span class="mi">0</span>
  
  <span class="nv">loading: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">loaded: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  
  <span class="nv">success: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">error: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  
  <span class="nv">send: </span><span class="nf">() -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Please source a dependency file for a request implementation&quot;</span> 
  
  <span class="nv">cancel: </span><span class="o">-&gt;</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">@_autosendTimeout</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@_autosendTimeout</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p><code>Batman.App</code> manages requiring files and acts as a namespace for all code subclassing
Batman objects.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Require path tells the require methods which base directory to look in.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@requirePath: </span><span class="s1">&#39;&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The require class methods (<code>controller</code>, <code>model</code>, <code>view</code>) simply tells
your app where to look for coffeescript source files. This
implementation may change in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@require: </span><span class="nf">(path, names...) -&gt;</span>
    <span class="nv">base = </span><span class="nx">@requirePath</span> <span class="o">+</span> <span class="nx">path</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
      <span class="nx">@prevent</span> <span class="s1">&#39;run&#39;</span>
      
      <span class="nv">path = </span><span class="nx">base</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.coffee&#39;</span> <span class="c1"># FIXME: don&#39;t hardcode this</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
        <span class="nv">url: </span><span class="nx">path</span>
        <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nb">eval</span> <span class="nx">response</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>FIXME: under no circumstances should we be compiling coffee in
the browser. This can be fixed via a real deployment solution
to compile coffeescripts, such as Sprockets.</p>             </td>             <td class="code">               <div class="highlight"><pre>          
          <span class="nx">@allow</span> <span class="s1">&#39;run&#39;</span>
          <span class="nx">@run</span><span class="p">()</span> <span class="c1"># FIXME: this should only happen if the client actually called run.</span>
    <span class="err">@</span>
  
  <span class="vi">@controller: </span><span class="nf">(names...) -&gt;</span>
    <span class="nx">@require</span> <span class="s1">&#39;controllers&#39;</span><span class="p">,</span> <span class="nx">names</span><span class="p">...</span>
  
  <span class="vi">@model: </span><span class="nf">(names...) -&gt;</span>
    <span class="nx">@require</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="nx">names</span><span class="p">...</span>
  
  <span class="vi">@view: </span><span class="nf">(names...) -&gt;</span>
    <span class="nx">@require</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">names</span><span class="p">...</span>
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Layout is the base view that other views can be yielded into. The
default behavior is that when <code>app.run()</code> is called, a new view will
be created for the layout using the <code>document</code> node as its content.
Use <code>MyApp.layout = null</code> to turn off the default behavior.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@layout: </span><span class="kc">undefined</span>
  </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Call <code>MyApp.run()</code> to start up an app. Batman level initializers will 
be run to bootstrap the application.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@run: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@hasRun</span>
    <span class="nv">Batman.currentApp = </span><span class="err">@</span>
    
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@layout</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="nx">@set</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span> <span class="nv">node: </span><span class="nb">document</span>
    
    <span class="nx">@startRouting</span><span class="p">()</span>
    <span class="vi">@hasRun = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>route matching courtesy of Backbone</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">namedParam = </span><span class="sr">/:([\w\d]+)/g</span>
<span class="nv">splatParam = </span><span class="sr">/\*([\w\d]+)/g</span>
<span class="nv">queryParam = </span><span class="s1">&#39;(?:\\?.+)?&#39;</span>
<span class="nv">namedOrSplat = </span><span class="sr">/[:|\*]([\w\d]+)/g</span>
<span class="nv">escapeRegExp = </span><span class="sr">/[-[\]{}()+?.,\\^$|#\s]/g</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p><code>Batman.Route</code> is a simple object representing a route
which a user might visit in the application.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Route = </span><span class="p">{</span>
  <span class="nv">isRoute: </span><span class="kc">yes</span>
  
  <span class="nv">pattern: </span><span class="kc">null</span>
  <span class="nv">regexp: </span><span class="kc">null</span>
  <span class="nv">namedArguments: </span><span class="kc">null</span>
  <span class="nv">action: </span><span class="kc">null</span>
  <span class="nv">context: </span><span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>call the action without going through the dispatch mechanism</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fire: </span><span class="nf">(args, context) -&gt;</span>
    <span class="nv">action = </span><span class="nx">@action</span>
    <span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">index = </span><span class="nx">action</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">controllerName = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Controller&#39;</span><span class="p">)</span>
        <span class="nv">controller = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">[</span><span class="nx">controllerName</span><span class="p">]</span>
        
        <span class="nv">context = </span><span class="nx">controller</span>
        <span class="k">if</span> <span class="nx">context</span><span class="o">?</span><span class="p">.</span><span class="nx">sharedInstance</span>
          <span class="nv">context = </span><span class="nx">context</span><span class="p">.</span><span class="nx">sharedInstance</span><span class="p">()</span>
        
        <span class="nv">action = </span><span class="nx">context</span><span class="p">[</span><span class="nx">action</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    
    <span class="nx">action</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span> <span class="o">||</span> <span class="nx">@context</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="k">if</span> <span class="nx">action</span>
  
  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;route: #{@pattern}&quot;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>The <code>route</code> and <code>redirect</code> methods are mixed in to the top level <code>Batman</code> object,
so at any point new routes can be added and redirected to.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">,</span>
  <span class="nv">HASH_PATTERN: </span><span class="s1">&#39;#!&#39;</span>
  <span class="nv">_routes: </span><span class="p">[]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><code>route</code> adds a new route to the global routing table. It accepts a pattern of the
Rails/Backbone variety with <code>:foo</code> denoting named arguments and <code>*bar</code> denoting 
repeated segements. It also accepts a callback to fire when the route is visited.
Note that route uses the <code>$block</code> helper, so it can be used in class definitions 
without wrapping brackets </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">route: </span><span class="nx">$block</span> <span class="nf">(pattern, callback) -&gt;</span>
    <span class="nv">f = </span><span class="nf">(params) -&gt;</span>
      <span class="nv">context = </span><span class="nx">f</span><span class="p">.</span><span class="nx">context</span> <span class="o">||</span> <span class="err">@</span>
      <span class="k">if</span> <span class="nx">context</span> <span class="o">and</span> <span class="nx">context</span><span class="p">.</span><span class="nx">sharedInstance</span>
        <span class="nv">context = </span><span class="nx">context</span><span class="p">.</span><span class="nx">sharedInstance</span><span class="p">()</span>
      
      <span class="nv">pattern = </span><span class="nx">f</span><span class="p">.</span><span class="nx">pattern</span>
      <span class="k">if</span> <span class="nx">params</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">params</span><span class="p">.</span><span class="nx">url</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">params</span>
          <span class="nv">pattern = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;[:|\*]&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">),</span> <span class="nx">value</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">params</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">params</span>
        <span class="nv">Batman.currentApp._cachedRoute = </span><span class="nx">pattern</span>
        <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">HASH_PATTERN</span> <span class="o">+</span> <span class="nx">pattern</span>
        
      <span class="k">if</span> <span class="nx">context</span> <span class="o">and</span> <span class="nx">context</span><span class="p">.</span><span class="nx">dispatch</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">dispatch</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">params</span>
      <span class="k">else</span>
        <span class="nx">f</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">context</span>
      
    <span class="nv">match = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escapeRegExp</span><span class="p">,</span> <span class="s1">&#39;\\$&amp;&#39;</span><span class="p">)</span>
    <span class="nv">regexp = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">namedParam</span><span class="p">,</span> <span class="s1">&#39;([^\/]*)&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">splatParam</span><span class="p">,</span> <span class="s1">&#39;(.*?)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">queryParam</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span>
    
    <span class="nv">namedArguments = </span><span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">array = </span><span class="nx">namedOrSplat</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">match</span><span class="p">))</span><span class="o">?</span>
      <span class="nx">namedArguments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      
    <span class="nx">$mixin</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Route</span><span class="p">,</span>
      <span class="nv">pattern: </span><span class="nx">match</span>
      <span class="nv">regexp: </span><span class="nx">regexp</span>
      <span class="nv">namedArguments: </span><span class="nx">namedArguments</span>
      <span class="nv">action: </span><span class="nx">callback</span>
      <span class="nv">context: </span><span class="err">@</span>
    
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">_routes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span>
    <span class="nx">f</span>
   </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><code>redirect</code> sets the <code>window.location.hash</code> to passed string or pattern of the passed route. This will
then trigger any route who's pattern matches the route and thus it's callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">redirect: </span><span class="nf">(urlOrFunction) -&gt;</span>
    <span class="nv">url = </span><span class="k">if</span> <span class="nx">urlOrFunction</span><span class="o">?</span><span class="p">.</span><span class="nx">isRoute</span> <span class="k">then</span> <span class="nx">urlOrFunction</span><span class="p">.</span><span class="nx">pattern</span> <span class="k">else</span> <span class="nx">urlOrFunction</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="s2">&quot;#{Batman.HASH_PATTERN}#{url}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Add the route and redirect helpers to the class level of all <code>Batman.Object</code> subclasses so they can be 
used declaratively within class definitions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.Object.route = Batman.App.route = $route = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">route</span>
<span class="nv">Batman.Object.redirect = Batman.App.redirect = $redirect = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">redirect</span>

<span class="nx">$mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">App</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p><code>startRouting</code> starts listening for changes to the window hash and dispatches routes when they change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">startRouting: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
    <span class="nv">parseUrl = </span><span class="o">=&gt;</span>
      <span class="nv">hash = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">HASH_PATTERN</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">hash</span> <span class="o">is</span> <span class="nx">@_cachedRoute</span>
      <span class="vi">@_cachedRoute = </span><span class="nx">hash</span>
      <span class="nx">@_dispatch</span> <span class="nx">hash</span>
    
    <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="s2">&quot;#{Batman.HASH_PATTERN}/&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">parseUrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;onhashchange&#39;</span> <span class="k">of</span> <span class="nb">window</span>
      <span class="vi">@_routeHandler = </span><span class="nx">parseUrl</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">parseUrl</span>
    <span class="k">else</span>
      <span class="nv">old = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span>
      <span class="vi">@_routeHandler = </span><span class="nx">setInterval</span> <span class="nx">parseUrl</span><span class="p">,</span> <span class="mi">100</span>
  </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p><code>stopRouting</code> stops any hash change listeners from dispatching routes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stopRouting: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@_routeHandler</span><span class="o">?</span>
    <span class="k">if</span> <span class="s1">&#39;onhashchange&#39;</span> <span class="k">of</span> <span class="nb">window</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">@_routeHandler</span>
      <span class="vi">@_routeHandler = </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="vi">@_routeHandler = </span><span class="nx">clearInterval</span> <span class="nx">@_routeHandler</span>
  
  <span class="nv">_dispatch: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">route = </span><span class="nx">@_matchRoute</span> <span class="nx">url</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">route</span>
      <span class="k">if</span> <span class="nx">url</span> <span class="o">is</span> <span class="s1">&#39;/404&#39;</span> <span class="k">then</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">[</span><span class="s1">&#39;404&#39;</span><span class="p">]()</span> <span class="k">else</span> <span class="nx">$redirect</span> <span class="s1">&#39;/404&#39;</span>
      <span class="k">return</span>
    
    <span class="nv">params = </span><span class="nx">@_extractParams</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">route</span>
    <span class="nx">route</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
  
  <span class="nv">_matchRoute: </span><span class="nf">(url) -&gt;</span>
    <span class="k">for</span> <span class="nx">route</span> <span class="k">in</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">_routes</span>
      <span class="k">return</span> <span class="nx">route</span> <span class="k">if</span> <span class="nx">route</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    
    <span class="kc">null</span>
  
  <span class="nv">_extractParams: </span><span class="nf">(url, route) -&gt;</span>
    <span class="p">[</span><span class="nx">url</span><span class="p">,</span> <span class="nx">query</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
    <span class="nv">array = </span><span class="nx">route</span><span class="p">.</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">params = url: </span><span class="nx">url</span>
    
    <span class="k">for</span> <span class="nx">param</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">array</span>
      <span class="nx">params</span><span class="p">[</span><span class="nx">route</span><span class="p">.</span><span class="nx">namedArguments</span><span class="p">[</span><span class="nx">index</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">param</span>
    
    <span class="k">if</span> <span class="nx">query</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

    <span class="nx">params</span>
  </pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p><code>root</code> is a shortcut for setting the root route.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">root: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">$route</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">callback</span>
  
  <span class="s1">&#39;404&#39;</span><span class="o">:</span> <span class="o">-&gt;</span>
    <span class="nv">view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
      <span class="nv">html: </span><span class="s1">&#39;&lt;h1&gt;Page could not be found&lt;/h1&gt;&#39;</span>
      <span class="nv">contentFor: </span><span class="s1">&#39;main&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <h2>Controllers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Controller</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>FIXME: should these be singletons?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@sharedInstance: </span><span class="o">-&gt;</span>
    <span class="vi">@_sharedInstance = </span><span class="k">new</span> <span class="err">@</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@_sharedInstance</span>
    <span class="nx">@_sharedInstance</span>
  
  <span class="vi">@beforeFilter: </span><span class="nf">(nameOrFunction) -&gt;</span>
    <span class="nv">filters = </span><span class="nx">@_beforeFilters</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nx">filters</span><span class="p">.</span><span class="nx">push</span> <span class="nx">nameOrFunction</span>
  
  <span class="vi">@resources: </span><span class="nf">(base) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>FIXME: MUST find a non-deferred way to do this</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="o">=&gt;</span>
      <span class="err">@</span><span class="o">::</span><span class="nv">index = </span><span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;/#{base}&quot;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">index</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="o">::</span><span class="nx">index</span>
      <span class="err">@</span><span class="o">::</span><span class="nv">create = </span><span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;/#{base}/new&quot;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">create</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="o">::</span><span class="nx">create</span>
      <span class="err">@</span><span class="o">::</span><span class="nv">show = </span><span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;/#{base}/:id&quot;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">show</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="o">::</span><span class="nx">show</span>
      <span class="err">@</span><span class="o">::</span><span class="nv">edit = </span><span class="nx">@route</span><span class="p">(</span><span class="s2">&quot;/#{base}/:id/edit&quot;</span><span class="p">,</span> <span class="err">@</span><span class="o">::</span><span class="nx">edit</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="o">::</span><span class="nx">edit</span>
    <span class="nx">setTimeout</span> <span class="nx">f</span><span class="p">,</span> <span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>name = helpers.underscore(@name.replace('Controller', ''))</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>$route "/#{base}", "#{name}#index"
$route "/#{base}/:id", "#{name}#show"
$route "/#{base}/:id/edit", "#{name}#edit"</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">dispatch: </span><span class="nf">(route, params...) -&gt;</span>
    <span class="nv">key = </span><span class="nx">$findName</span> <span class="nx">route</span><span class="p">,</span> <span class="err">@</span>
    
    <span class="vi">@_actedDuringAction = </span><span class="kc">no</span>
    <span class="vi">@_currentAction = </span><span class="nx">key</span>
    
    <span class="nv">filters = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_beforeFilters</span>
    <span class="k">if</span> <span class="nx">filters</span>
      <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">filters</span>
        <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
    
    <span class="nv">result = </span><span class="nx">route</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">params</span><span class="p">,</span> <span class="err">@</span>
    
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_actedDuringAction</span>
      <span class="nx">@render</span><span class="p">()</span>
    
    <span class="k">delete</span> <span class="nx">@_actedDuringAction</span>
    <span class="k">delete</span> <span class="nx">@_currentAction</span>
  
  <span class="nv">redirect: </span><span class="nf">(url) -&gt;</span>
    <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>
    <span class="nx">$redirect</span> <span class="nx">url</span>
  
  <span class="nv">render: </span><span class="nf">(options = {}) -&gt;</span>
    <span class="vi">@_actedDuringAction = </span><span class="kc">yes</span>
    
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nv">options.source = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">@_currentAction</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
      <span class="nv">options.view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nv">view = </span><span class="nx">options</span><span class="p">.</span><span class="nx">view</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">context</span> <span class="o">||=</span> <span class="err">@</span> 
      <span class="nx">view</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h2>Models</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h2>Model API</h2>

<p>Pick one or many mechanisms with which this model should be persisted. The mechanisms
can be already instantiated or just the class defining them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@persist: </span><span class="nf">(mechanisms...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">storage = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">storage</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">mechanism</span> <span class="k">in</span> <span class="nx">mechanisms</span>
      <span class="nx">storage</span><span class="p">.</span><span class="nx">push</span> <span class="k">if</span> <span class="nx">mechanism</span><span class="p">.</span><span class="nx">isStorageAdapter</span> <span class="k">then</span> <span class="nx">mechanism</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">mechanism</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="err">@</span>
  </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h3>Query methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@accessor</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@all</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span><span class="p">}</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">get: </span><span class="o">-&gt;</span> <span class="vi">@first = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
  <span class="nx">@accessor</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">get: </span><span class="o">-&gt;</span> <span class="vi">@last = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="nx">@all</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]}</span>
  
  <span class="vi">@find: </span><span class="nf">(id) -&gt;</span>
    <span class="k">return</span> <span class="nx">record</span> <span class="k">if</span> <span class="p">(</span><span class="nv">record = </span><span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span>
    <span class="nv">record = </span><span class="k">new</span> <span class="err">@</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">load</span><span class="p">()),</span> <span class="mi">0</span>
    <span class="nx">record</span>
  </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h3>Transport methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Create a before load event. Clear the <code>all</code> set.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@beforeLoad: </span><span class="nx">@event</span> <span class="o">-&gt;</span> <span class="nx">@get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">clear</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Create an after load event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@afterLoad: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p><code>load</code> fetches the record from all sources possible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@load: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">do</span> <span class="nx">@beforeLoad</span>
    
    <span class="nv">afterLoad = </span><span class="o">=&gt;</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nx">do</span> <span class="nx">@afterLoad</span>
    
    <span class="nv">allMechanisms = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">getAll</span> <span class="s1">&#39;storage&#39;</span>
    <span class="nv">fireImmediately = </span><span class="o">!</span><span class="nx">allMechanisms</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">allMechanisms</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">fireImmediately</span>
    <span class="k">for</span> <span class="nx">mechanisms</span> <span class="k">in</span> <span class="nx">allMechanisms</span>
      <span class="nv">fireImmediately = </span><span class="nx">fireImmediately</span> <span class="o">||</span> <span class="o">!</span><span class="nx">mechanisms</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">mechanisms</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">readAllFromStorage</span> <span class="err">@</span><span class="p">,</span> <span class="nx">afterLoad</span>
    
    <span class="nx">do</span> <span class="nx">afterLoad</span> <span class="k">if</span> <span class="nx">fireImmediately</span>
  </pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Encoders are the tiny bits of logic which manage marshalling Batman models to and from their 
storage representations. Encoders do things like stringifying dates and parsing them back out again,
pulling out nested model collections and instantiating them (and JSON.stringifying them back again),
and marshalling otherwise un-storable object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@encode: </span><span class="nf">(keys...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleHash</span>
    
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">encoders</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="s1">&#39;&#39;</span><span class="o">+</span><span class="nx">value</span>
      
      <span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">decoders</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="nx">value</span>
  </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Validations allow a model to be marked as 'valid' or 'invalid' based on a set of programmatic rules.
By validating our data before it gets to the server we can provide immediate feedback to the user about
what they have entered and forgo waiting on a round trip to the server.
<code>validate</code> allows the attachment of validations to the model on particular keys, where the validation is
either a built in one (by use of options to pass to them) or a cusom one (by use of a custom function as
the second argument).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@validate: </span><span class="nf">(keys..., optionsOrFunction) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="nx">@prototype</span>
    <span class="nv">validators = </span><span class="err">@</span><span class="o">::</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">validators</span> <span class="o">||=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">optionsOrFunction</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Given a function, use that as the actual validator, expecting it to conform to the API
the built in validators do.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">keys: </span><span class="nx">keys</span>
        <span class="nv">callback: </span><span class="nx">optionsOrFunction</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Given options, find the validations which match the given options, and add them to the validators
array.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">options = </span><span class="nx">optionsOrFunction</span>
      <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">Validators</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">matches = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">matches</span><span class="p">(</span><span class="nx">options</span><span class="p">))</span>
          <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">match</span><span class="p">]</span> <span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>
          <span class="nx">validators</span><span class="p">.</span><span class="nx">push</span>
            <span class="nv">keys: </span><span class="nx">keys</span>
            <span class="nv">validator: </span><span class="k">new</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">matches</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Each model instance (each record) can be in one of many states throughout its lifetime. Since various 
operations on the model are asynchronous, these states are used to indicate exactly what point the 
record is at in it's lifetime, which can often be during a save or load operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="err">@</span><span class="o">::</span><span class="nx">mixin</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StateMachine</span>
  </pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Add the various states to the model.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">,</span> <span class="s1">&#39;saving&#39;</span><span class="p">]</span>
    <span class="err">@</span><span class="o">::</span><span class="nx">state</span> <span class="nx">k</span>
  <span class="err">@</span><span class="o">::</span><span class="nx">state</span> <span class="s1">&#39;saved&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h3>Record API</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>New records can be constructed by passing either an ID or a hash of attributes (potentially
containing an ID) to the Model constructor. By not passing an ID, the model is marked as new.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(idOrAttributes = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>We have to do this ahead of super, because mixins will call set which calls things on dirtyKeys.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dirtyKeys = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
    <span class="vi">@errors = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Set</span>
    
    <span class="k">super</span>
    <span class="nx">@empty</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@state</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Find the ID from either the first argument or the attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">id = </span><span class="k">if</span> <span class="nx">$typeOf</span><span class="p">(</span><span class="nx">idOrAttributes</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;String&#39;</span> <span class="k">then</span> <span class="nx">idOrAttributes</span> <span class="k">else</span> <span class="nx">idOrAttributes</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
      <span class="vi">@id = </span><span class="s2">&quot;#{id}&quot;</span>
      <span class="nx">@constructor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Override the <code>Batman.Observable</code> implementation of <code>set</code> to implement dirty tracking.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Optimize setting where the value is the same as what's already been set.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">oldValue = </span><span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">oldValue</span> <span class="o">is</span> <span class="nx">value</span>
    </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Actually set the value and note what the old value was in the tracking array.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">super</span>
    <span class="nx">@dirtyKeys</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Mark the model as dirty if isn't already.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@dirty</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@state</span><span class="p">()</span> <span class="o">isnt</span> <span class="s1">&#39;dirty&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>FIXME: Is this really needed?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="err">@</span><span class="o">::</span><span class="nx">accessor</span> <span class="s1">&#39;dirtyKeys&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@dirtyKeys</span>
  </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p><code>toJSON</code> uses the various encoders for each key to grab a storable representation of the record.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Encode each key into a new object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">encoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;encoders&#39;</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="o">!</span><span class="nx">encoders</span> <span class="o">or</span> <span class="nx">encoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nx">encoders</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">encoder</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">encoder</span><span class="p">(</span><span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    
    <span class="nx">obj</span>
  </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p><code>fromJSON</code> uses the various decoders for each key to generate a record instance from the JSON 
stored in whichever storage mechanism.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fromJSON: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">obj = </span><span class="p">{}</span>
    <span class="nv">decoders = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;decoders&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>If no decoders were specified, do the best we can to interpret the given JSON by camelizing 
each key and just setting the values.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">decoders</span> <span class="o">or</span> <span class="nx">decoders</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>If we do have decoders, use them to get the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">decoders</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(key, decoder) -&gt;</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Mixin the buffer object to use optimized and event-preventing sets used by <code>mixin</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@mixin</span> <span class="nx">obj</span>
  </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Set up the lifecycle events for a record.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">beforeLoad: </span><span class="nx">@event</span> <span class="o">-&gt;</span> <span class="nx">@loading</span><span class="p">();</span> <span class="kc">true</span>
  <span class="nv">afterLoad: </span><span class="nx">@event</span> <span class="o">-&gt;</span> <span class="nx">@loaded</span><span class="p">();</span> <span class="kc">true</span>
  <span class="nv">beforeCreate: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">afterCreate: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">beforeSave: </span><span class="nx">@event</span> <span class="o">-&gt;</span> <span class="nx">@saving</span><span class="p">();</span> <span class="kc">true</span>
  <span class="nv">afterSave: </span><span class="nx">@event</span> <span class="o">-&gt;</span> <span class="nx">@saved</span><span class="p">();</span> <span class="kc">true</span>
  <span class="nv">beforeValidation: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  <span class="nv">afterValidation: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p><code>load</code> fetches the record from all sources possible    </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">load: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">do</span> <span class="nx">@beforeLoad</span>
    
    <span class="nv">afterLoad = </span><span class="o">=&gt;</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nx">do</span> <span class="nx">@afterLoad</span>
    
    <span class="nv">allMechanisms = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">getAll</span> <span class="s1">&#39;storage&#39;</span>
    <span class="nv">fireImmediately = </span><span class="o">!</span><span class="nx">allMechanisms</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">mechanisms</span> <span class="k">in</span> <span class="nx">allMechanisms</span>
      <span class="nv">fireImmediately = </span><span class="nx">fireImmediately</span> <span class="o">||</span> <span class="o">!</span><span class="nx">mechanisms</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">mechanisms</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">readFromStorage</span> <span class="err">@</span><span class="p">,</span> <span class="nx">afterLoad</span>
    
    <span class="nx">do</span> <span class="nx">afterLoad</span> <span class="k">if</span> <span class="nx">fireImmediately</span>
  </pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p><code>save</code> persists a record to all the storage mechanisms added using <code>@persist</code>. <code>save</code> will only save
a model if it is valid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">save: </span><span class="nf">(callback) -&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@isValid</span><span class="p">()</span>
    <span class="nx">do</span> <span class="nx">@beforeSave</span>
    
    <span class="nv">creating = </span><span class="o">!</span><span class="nx">@id</span>
    <span class="nx">do</span> <span class="nx">@beforeCreate</span> <span class="k">if</span> <span class="nx">creating</span>
    
    <span class="nv">afterSave = </span><span class="o">=&gt;</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nx">do</span> <span class="nx">@afterCreate</span> <span class="k">if</span> <span class="nx">creating</span>
      <span class="nx">do</span> <span class="nx">@afterSave</span>
    
    <span class="nv">allMechanisms = </span><span class="nx">@_batman</span><span class="p">.</span><span class="nx">getAll</span> <span class="s1">&#39;storage&#39;</span>
    <span class="nv">fireImmediately = </span><span class="o">!</span><span class="nx">allMechanisms</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">mechanisms</span> <span class="k">in</span> <span class="nx">allMechanisms</span>
      <span class="nv">fireImmediately = </span><span class="nx">fireImmediately</span> <span class="o">||</span> <span class="o">!</span><span class="nx">mechanisms</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">mechanisms</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">writeToStorage</span> <span class="err">@</span><span class="p">,</span> <span class="nx">afterSave</span>
    
    <span class="nx">do</span> <span class="nx">afterSave</span> <span class="k">if</span> <span class="nx">fireImmediately</span>
  </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p><code>validate</code> performs the record level validations determining the record's validity. These may be asynchronous, 
in which case <code>validate</code> has no useful return value. Results from asynchronous validations can be received by
listening to the <code>afterValidation</code> lifecycle callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validate: </span><span class="o">-&gt;</span>
    <span class="nx">do</span> <span class="nx">@beforeValidation</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Start off assuming the validation is synchronous, and as they are each run, ensure each in fact is.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">async = </span><span class="kc">no</span>

    <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;validators&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]</span>
      <span class="nv">v = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">validator</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Run the validator <code>v</code> or the custom callback on each key it validates by instantiating a new promise
and passing it to the appropriate function along with the key and the value to be validated.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">keys</span>
        <span class="nv">promise = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ValidatorPromise</span> <span class="err">@</span>
        <span class="k">if</span> <span class="nx">v</span> 
          <span class="nx">v</span><span class="p">.</span><span class="nx">validateEach</span> <span class="nx">promise</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@get</span> <span class="nx">key</span> 
        <span class="k">else</span> 
          <span class="nx">validator</span><span class="p">.</span><span class="nx">callback</span> <span class="nx">promise</span><span class="p">,</span> <span class="err">@</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@get</span> <span class="nx">key</span>
        </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>In the event the validation is async (marked this way because the promise is paused), then
prevent the after callback from running, and run it only after all the promises have resolved.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">paused</span>
          <span class="nx">@prevent</span> <span class="s1">&#39;afterValidation&#39;</span>
          <span class="nx">promise</span><span class="p">.</span><span class="nx">resume</span> <span class="o">=&gt;</span> <span class="nx">@allow</span><span class="p">(</span><span class="s1">&#39;afterValidation&#39;</span><span class="p">);</span> <span class="nx">@afterValidation</span><span class="p">()</span>
          <span class="nv">async = </span><span class="kc">yes</span>
        <span class="k">else</span>
          <span class="nx">promise</span><span class="p">.</span><span class="nx">success</span><span class="p">()</span> <span class="k">if</span> <span class="nx">promise</span><span class="p">.</span><span class="nx">canSucceed</span>
    </pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Return the result of the validation if synchronous, otherwise call the validation callback.
FIXME: Is this really right?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">async</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">no</span> <span class="k">else</span> <span class="nx">do</span> <span class="nx">@afterValidation</span>
  
  <span class="err">@</span><span class="o">::</span><span class="nx">accessor</span>
    <span class="nv">isValid: </span><span class="o">-&gt;</span>
      <span class="nx">@errors</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
      <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">@validate</span><span class="p">()</span> <span class="o">is</span> <span class="kc">no</span>
      <span class="nx">@errors</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
  

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">ValidatorPromise</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@record) -&gt;</span>
    <span class="vi">@canSucceed = </span><span class="kc">yes</span>
  
  <span class="nv">error: </span><span class="nf">(err) -&gt;</span>
    <span class="nx">@record</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">add</span> <span class="nx">err</span>
    <span class="vi">@canSucceed = </span><span class="kc">no</span>
  
  <span class="nv">wait: </span><span class="o">-&gt;</span>
    <span class="vi">@paused = </span><span class="kc">yes</span>
    <span class="vi">@canSucceed = </span><span class="kc">no</span>
  
  <span class="nv">resume: </span><span class="nx">@event</span> <span class="o">-&gt;</span>
    <span class="vi">@paused = </span><span class="kc">no</span>
    <span class="kc">true</span>
  
  <span class="nv">success: </span><span class="o">-&gt;</span>
    <span class="vi">@canSucceed = </span><span class="kc">no</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@options, mixins...) -&gt;</span>
    <span class="k">super</span> <span class="nx">mixins</span><span class="p">...</span>
  
  <span class="nv">validate: </span><span class="nf">(record) -&gt;</span>
    <span class="k">throw</span> <span class="s2">&quot;You must override validate in Batman.Validator subclasses.&quot;</span>
  
  <span class="vi">@kind: </span><span class="o">-&gt;</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@name</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;_validator&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="nv">kind: </span><span class="o">-&gt;</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">kind</span><span class="p">()</span>
  
  <span class="vi">@options: </span><span class="nf">(options...) -&gt;</span>
    <span class="nx">Batman</span><span class="p">.</span><span class="nx">initializeObject</span> <span class="err">@</span>
    <span class="k">if</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span> <span class="k">then</span> <span class="nx">@_batman</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="k">else</span> <span class="vi">@_batman.options = </span><span class="nx">options</span>
  
  <span class="vi">@matches: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">results = </span><span class="p">{}</span>
    <span class="nv">shouldReturn = </span><span class="kc">no</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">options</span>
      <span class="k">if</span> <span class="o">~</span><span class="nx">@_batman</span><span class="o">?</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="nx">results</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="nv">shouldReturn = </span><span class="kc">yes</span>
    <span class="k">return</span> <span class="nx">results</span> <span class="k">if</span> <span class="nx">shouldReturn</span>

<span class="nv">Validators = Batman.Validators = </span><span class="p">[</span>
  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LengthValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;minLength&#39;</span><span class="p">,</span> <span class="s1">&#39;maxLength&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthWithin&#39;</span><span class="p">,</span> <span class="s1">&#39;lengthIn&#39;</span>
    <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
      <span class="k">if</span> <span class="nv">range = </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span><span class="p">)</span>
        <span class="nv">options.minLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">options.maxLength = </span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthWithin</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lengthIn</span>
      
      <span class="k">super</span>
      
    <span class="nv">validateEach: </span><span class="nf">(validator, record, key, value) -&gt;</span>
      <span class="nv">options = </span><span class="nx">@options</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minLength</span>
        <span class="nx">validator</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;#{key} must be at least #{options.minLength} characters&quot;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxLength</span>
        <span class="nx">validator</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;#{key} must be less than #{options.maxLength} characters&quot;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">validator</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;#{key} must be #{options.length} characters&quot;</span>
  
  <span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">PresenceValidator</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Validator</span>
    <span class="nx">@options</span> <span class="s1">&#39;presence&#39;</span>
    <span class="nv">validateEach: </span><span class="nf">(validator, record, key, value) -&gt;</span>
      <span class="nv">options = </span><span class="nx">@options</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">presence</span> <span class="o">and</span> <span class="o">!</span><span class="nx">value</span><span class="o">?</span>
        <span class="nx">validator</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;#{key} must be present&quot;</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageMechanism</span>
  <span class="nv">constructor: </span><span class="nf">(@model) -&gt;</span>
    <span class="vi">@modelKey = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">underscore</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
  <span class="nv">isStorageAdapter: </span><span class="kc">true</span>
  <span class="vi">@makesStorageAdapters: </span><span class="kc">true</span>

<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">LocalStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageMechanism</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="o">not</span> <span class="s1">&#39;localStorage&#39;</span> <span class="k">in</span> <span class="nb">window</span>
    <span class="vi">@id = </span><span class="mi">0</span>
    <span class="k">super</span>
  
  <span class="nv">writeToStorage: </span><span class="nf">(record, callback) -&gt;</span>
    <span class="nv">key = </span><span class="nx">@modelKey</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">id</span> <span class="o">||=</span> <span class="o">++</span><span class="nx">@id</span>
    <span class="nx">localStorage</span><span class="p">[</span><span class="nx">key</span> <span class="o">+</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">and</span> <span class="nx">id</span>
    <span class="nx">callback</span><span class="p">()</span>
  
  <span class="nv">readFromStorage: </span><span class="nf">(record, callback) -&gt;</span>
    <span class="nv">key = </span><span class="nx">@modelKey</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">id</span>
    <span class="nv">json = </span><span class="nx">localStorage</span><span class="p">[</span><span class="nx">key</span> <span class="o">+</span> <span class="nx">id</span><span class="p">]</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">and</span> <span class="nx">id</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">json</span>
    <span class="nx">callback</span><span class="p">()</span>
    
<span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RestStorage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">StorageMechanism</span>
  <span class="nv">writeToStorage: </span><span class="nf">(record, callback) -&gt;</span>
    <span class="nv">key = </span><span class="nx">@modelKey</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
      <span class="nv">url: </span><span class="s2">&quot;/#{key}/#{id}&quot;</span>
      <span class="nv">method: </span><span class="k">if</span> <span class="nx">id</span> <span class="k">then</span> <span class="s1">&#39;put&#39;</span> <span class="k">else</span> <span class="s1">&#39;post&#39;</span>
      <span class="nv">data: </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">record</span>
      <span class="nv">success: </span><span class="o">-&gt;</span>
        <span class="nx">callback</span><span class="p">()</span>
      <span class="nv">error: </span><span class="nf">(error) -&gt;</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  
  <span class="nv">readFromStorage: </span><span class="nf">(record, callback) -&gt;</span>
    <span class="nv">id = </span><span class="nx">record</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">id</span>
    <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
      <span class="nv">url: </span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="s2">&quot;/#{@modelKey}&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/#{id}&quot;</span>
      <span class="nv">type: </span><span class="s1">&#39;json&#39;</span>
      <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
        <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">data</span>
          <span class="nv">data = </span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="k">break</span>
        
        <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span> <span class="nx">data</span>
        <span class="nx">callback</span><span class="p">()</span>
        
  <span class="nv">readAllFromStorage: </span><span class="nf">(model, callback) -&gt;</span>
    <span class="nv">key = </span><span class="nx">@modelKey</span>
    <span class="nv">r = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
      <span class="nv">url: </span><span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="s2">&quot;/#{key}&quot;</span>
      <span class="nv">type: </span><span class="s1">&#39;json&#39;</span>
      <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
        <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="k">if</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
          <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">data</span>
            <span class="nv">data = </span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
            <span class="k">break</span>
        
        <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">data</span>
          <span class="nv">record = </span><span class="k">new</span> <span class="nx">model</span> <span class="s1">&#39;&#39;</span><span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span>
          <span class="nx">record</span><span class="p">.</span><span class="nx">fromJSON</span> <span class="nx">obj</span>
        
        <span class="nx">callback</span><span class="p">()</span>
        <span class="k">return</span>
    </pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <h2>Views</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>A <code>Batman.View</code> can function two ways: a mechanism to load and/or parse html files
or a root of a subclass hierarchy to create rich UI classes, like in Cocoa.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">viewSources = </span><span class="p">{}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Set the source attribute to an html file to have that file loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">source: </span><span class="s1">&#39;&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Set the html to a string of html to have that html parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">html: </span><span class="s1">&#39;&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Set an existing DOM node to parse immediately.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">node: </span><span class="kc">null</span>
  
  <span class="nv">context: </span><span class="kc">null</span>
  <span class="nv">contexts: </span><span class="kc">null</span>
  <span class="nv">contentFor: </span><span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Fires once a node is parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ready: </span><span class="nx">@eventOneShot</span> <span class="o">-&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Where to look for views on the server</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">prefix: </span><span class="s1">&#39;views&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Whenever the source changes we load it up asynchronously</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="err">@</span><span class="o">::</span><span class="nx">observe</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@reloadSource</span><span class="p">()),</span> <span class="mi">0</span>
  
  <span class="nv">reloadSource: </span><span class="o">-&gt;</span>
    <span class="nv">source = </span><span class="nx">@get</span> <span class="s1">&#39;source&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">source</span>
    
    <span class="k">if</span> <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
      <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">])</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Request</span>
        <span class="nv">url: </span><span class="s2">&quot;views/#{@source}&quot;</span>
        <span class="nv">type: </span><span class="s1">&#39;html&#39;</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">viewSources</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span>
          <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
        <span class="nv">error: </span><span class="nf">(response) -&gt;</span>
          <span class="k">throw</span> <span class="s2">&quot;Could not load view from #{url}&quot;</span>
  
  <span class="err">@</span><span class="o">::</span><span class="nx">observe</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nf">(html) -&gt;</span>
    <span class="nv">node = </span><span class="nx">@node</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
    <span class="nv">node.innerHTML = </span><span class="nx">html</span>
    
    <span class="nx">@set</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@node</span> <span class="o">isnt</span> <span class="nx">node</span>
  
  <span class="err">@</span><span class="o">::</span><span class="nx">observe</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">node</span>
    <span class="vi">@ready.fired = </span><span class="kc">false</span>
    
    <span class="k">if</span> <span class="nx">@_renderer</span>
      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">forgetAll</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>We use a renderer with the continuation style rendering engine to not
block user interaction for too long during the render.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">node</span>
      <span class="vi">@_renderer = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span><span class="p">(</span> <span class="nx">node</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">content = </span><span class="nx">@contentFor</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">content</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
          <span class="vi">@contentFor = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="o">?</span><span class="p">[</span><span class="nx">content</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nx">@contentFor</span> <span class="o">and</span> <span class="nx">node</span>
          <span class="vi">@contentFor.innerHTML = </span><span class="s1">&#39;&#39;</span>
          <span class="nx">@contentFor</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        
        <span class="nx">@ready</span> <span class="nx">node</span>
      <span class="p">,</span> <span class="nx">@contexts</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Ensure any context object explicitly given for use in rendering the view (in <code>@context</code>) gets passed to the renderer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_renderer</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@context</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@context</span>
      <span class="vi">@_renderer.contextObject.view = </span><span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h2>DOM Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p><code>Batman.Renderer</code> will take a node and parse all recognized data attributes out of it and its children. 
It is a continuation style parser, designed not to block for longer than 50ms at a time if the document 
fragment is particularly long.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
  <span class="nv">constructor: </span><span class="nf">(@node, @callback, contexts) -&gt;</span>
    <span class="k">super</span>
    <span class="vi">@contexts = </span><span class="nx">contexts</span> <span class="o">||</span> <span class="p">[</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span><span class="p">]</span>
    <span class="vi">@contextObject = </span><span class="nx">@contexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nx">setTimeout</span> <span class="nx">@start</span><span class="p">,</span> <span class="mi">0</span>
  
  <span class="nv">start: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@node</span>
  
  <span class="nv">resume: </span><span class="o">=&gt;</span>
    <span class="vi">@startTime = </span><span class="k">new</span> <span class="nb">Date</span>
    <span class="nx">@parseNode</span> <span class="nx">@resumeNode</span>
  
  <span class="nv">finish: </span><span class="o">-&gt;</span>
    <span class="vi">@startTime = </span><span class="kc">null</span>
    <span class="nx">@callback</span><span class="o">?</span><span class="p">()</span>
  
  <span class="nv">forgetAll: </span><span class="o">-&gt;</span>
    
  <span class="nv">regexp = </span><span class="sr">/data\-(.*)/</span>
  
  <span class="nv">parseNode: </span><span class="nf">(node) -&gt;</span>
    <span class="k">if</span> <span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">@startTime</span> <span class="o">&gt;</span> <span class="mi">50</span>
      <span class="vi">@resumeNode = </span><span class="nx">node</span>
      <span class="nx">setTimeout</span> <span class="nx">@resume</span><span class="p">,</span> <span class="mi">0</span>
      <span class="k">return</span>
    
    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span>
      <span class="vi">@contextObject.node = </span><span class="nx">node</span>
      <span class="nv">contexts = </span><span class="nx">@contexts</span>
      
      <span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span>
        <span class="nv">name = </span><span class="nx">attr</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">regexp</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">name</span>
                
        <span class="nv">result = </span><span class="k">if</span> <span class="p">(</span><span class="nv">index = </span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">contexts</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">[</span><span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">)]</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">contexts</span><span class="p">,</span> <span class="err">@</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nx">result</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="nv">skipChildren = </span><span class="kc">true</span>
          <span class="k">break</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nv">nextNode = </span><span class="nx">@nextNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">skipChildren</span><span class="p">))</span> <span class="k">then</span> <span class="nx">@parseNode</span><span class="p">(</span><span class="nx">nextNode</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@finish</span><span class="p">()</span>
  
  <span class="nv">nextNode: </span><span class="nf">(node, skipChildren) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">skipChildren</span>
      <span class="nv">children = </span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span>
      <span class="k">return</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">children</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
    
    <span class="nx">node</span><span class="p">.</span><span class="nx">onParseExit</span><span class="o">?</span><span class="p">()</span>
    
    <span class="nv">sibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="k">return</span> <span class="nx">sibling</span> <span class="k">if</span> <span class="nx">sibling</span>
    
    <span class="nv">nextParent = </span><span class="nx">node</span>
    <span class="k">while</span> <span class="nv">nextParent = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="nx">nextParent</span><span class="p">.</span><span class="nx">onParseExit</span><span class="o">?</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>return if nextParent is @node
FIXME: we need a way to break if you exit the original node context of the renderer.</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="nv">parentSibling = </span><span class="nx">nextParent</span><span class="p">.</span><span class="nx">nextSibling</span>
      <span class="k">return</span> <span class="nx">parentSibling</span> <span class="k">if</span> <span class="nx">parentSibling</span>
    
    <span class="k">return</span>
    </pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p><code>matchContext</code> is used to find which context in a stack of objects which responds to a sought key.
A matching context is returned if found, and if it isn't, the global object is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">matchContext = </span><span class="nf">(contexts, key) -&gt;</span>
  <span class="nv">base = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">i = </span><span class="nx">contexts</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">while</span> <span class="nx">i</span><span class="o">--</span>
    <span class="nv">context = </span><span class="nx">contexts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span><span class="o">?</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">context</span><span class="p">[</span><span class="nx">base</span><span class="p">])</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">context</span>

  <span class="k">return</span> <span class="nx">container</span>

<span class="nv">Batman.DOM = </span><span class="p">{</span>
  </pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p><code>Batman.DOM.readers</code> contains the functions used for binding a node's value or innerHTML, showing/hiding nodes,
and any other <code>data-#{name}=""</code> style DOM directives.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readers: </span><span class="p">{</span>
    <span class="nv">bind: </span><span class="nf">(node, key, contexts) -&gt;</span>
      <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nv">shouldSet = </span><span class="kc">yes</span>
      
      <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">change</span> <span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="nv">shouldSet = </span><span class="kc">no</span>
          <span class="nx">context</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span>
          <span class="nv">shouldSet = </span><span class="kc">yes</span>
      
      <span class="nx">context</span><span class="p">.</span><span class="nx">observe</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="k">if</span> <span class="nx">shouldSet</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">valueForNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">value</span>
    
    <span class="nv">context: </span><span class="nf">(node, key, contexts) -&gt;</span>
      <span class="nv">context = </span><span class="nx">matchContext</span><span class="p">(</span><span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">context</span>
      
      <span class="nv">node.onParseExit = </span><span class="o">-&gt;</span>
        <span class="nv">index = </span><span class="nx">contexts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
        <span class="nx">contexts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">contexts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">index</span><span class="p">)</span>
    
    <span class="nv">mixin: </span><span class="nf">(node, key, contexts) -&gt;</span>
      <span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Batman</span><span class="p">.</span><span class="nx">mixins</span><span class="p">)</span>
      <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nv">mixin = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span>
      <span class="nx">contexts</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

      <span class="nx">$mixin</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">mixin</span>
    
    <span class="nv">showif: </span><span class="nf">(node, key, contexts, renderer, invert) -&gt;</span>
      <span class="nv">originalDisplay = </span><span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>
      <span class="nv">originalDisplay = </span><span class="s1">&#39;block&#39;</span> <span class="k">if</span> <span class="o">!</span><span class="nx">originalDisplay</span> <span class="o">or</span> <span class="nx">originalDisplay</span> <span class="o">is</span> <span class="s1">&#39;none&#39;</span>
      
      <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
      
      <span class="nx">context</span><span class="p">.</span><span class="nx">observe</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">invert</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">show</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">node</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span> <span class="k">else</span> <span class="nv">node.style.display = </span><span class="nx">originalDisplay</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hide</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">node</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span> <span class="k">else</span> <span class="nv">node.style.display = </span><span class="s1">&#39;none&#39;</span>
    
    <span class="nv">hideif: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">readers</span><span class="p">.</span><span class="nx">showif</span> <span class="nx">args</span><span class="p">...,</span> <span class="kc">yes</span>
    
    <span class="nv">route: </span><span class="nf">(node, key, contexts) -&gt;</span>
      <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;/&#39;</span>
        <span class="nv">route = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">redirect</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">Batman</span><span class="p">,</span> <span class="nx">key</span>
        <span class="nv">routeName = </span><span class="nx">key</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">index = </span><span class="nx">key</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">controllerName = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;Controller&#39;</span>
        <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">controllerName</span>
        <span class="nv">controller = </span><span class="nx">context</span><span class="p">[</span><span class="nx">controllerName</span><span class="p">]</span>
        
        <span class="nv">route = </span><span class="nx">controller</span><span class="o">?</span><span class="p">.</span><span class="nx">sharedInstance</span><span class="p">()[</span><span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="nv">routeName = </span><span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">pattern</span>
      <span class="k">else</span>
        <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
        <span class="nv">route = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span>
        
        <span class="k">if</span> <span class="nx">route</span> <span class="k">instanceof</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
          <span class="nv">controllerName = </span><span class="nx">helpers</span><span class="p">.</span><span class="nx">camelize</span><span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;Controller&#39;</span>
          <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">controllerName</span>
          <span class="nv">controller = </span><span class="nx">context</span><span class="p">[</span><span class="nx">controllerName</span><span class="p">].</span><span class="nx">sharedInstance</span><span class="p">()</span>
          
          <span class="nv">id = </span><span class="nx">route</span><span class="p">.</span><span class="nx">id</span>
          <span class="nv">route = </span><span class="nx">controller</span><span class="p">.</span><span class="nx">show</span><span class="o">?</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">controller</span><span class="p">,</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">})</span>
          <span class="nv">routeName = </span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">id</span>
        <span class="k">else</span>
          <span class="nv">routeName = </span><span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">pattern</span>
      
      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span>
        <span class="nv">node.href = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">HASH_PATTERN</span> <span class="o">+</span> <span class="p">(</span><span class="nx">routeName</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">click</span> <span class="nx">node</span><span class="p">,</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">do</span> <span class="nx">route</span><span class="p">)</span>
    
    <span class="nv">partial: </span><span class="nf">(node, path, contexts) -&gt;</span>
      <span class="nv">view = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">View</span>
        <span class="nv">source: </span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
        <span class="nv">contentFor: </span><span class="nx">node</span>
        <span class="nv">contexts: </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">contexts</span><span class="p">)</span>
    
    <span class="nv">yield: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">yield</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">),</span> <span class="mi">0</span>
    
    <span class="nv">contentfor: </span><span class="nf">(node, key) -&gt;</span>
      <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">contentFor</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">),</span> <span class="mi">0</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p><code>Batman.DOM.attrReaders</code> contains all the DOM directives which take an argument in their name, in the <code>data-dosomething-argument="keypath"</code> style.
This means things like foreach, binding attributes like disabled or anything arbitrary, descending into a context, binding specific classes, 
or binding to events.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attrReaders: </span><span class="p">{</span>
    <span class="nv">bind: </span><span class="nf">(node, attr, key, contexts) -&gt;</span>
      <span class="nv">filters = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s*\|\s*/</span><span class="p">)</span>
      <span class="nv">key = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">while</span> <span class="nv">filterName = </span><span class="nx">filters</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
          <span class="nv">args = </span><span class="nx">filterName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
          <span class="nv">filterName = </span><span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
          
          <span class="nv">filter = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span><span class="nx">filterName</span><span class="p">]</span> <span class="o">||</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">helpers</span><span class="p">[</span><span class="nx">filterName</span><span class="p">]</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">filter</span>
          
          <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;@&#39;</span>
            <span class="nv">key = </span><span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
            <span class="nv">key = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          
          <span class="nv">value = </span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">args</span><span class="p">...,</span> <span class="nx">node</span><span class="p">)</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span>
      <span class="k">else</span>
        <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">observe</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
          <span class="k">if</span> <span class="nx">attr</span> <span class="o">is</span> <span class="s1">&#39;value&#39;</span>
            <span class="nv">node.value = </span><span class="nx">value</span>
          <span class="k">else</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span>
      
        <span class="k">if</span> <span class="nx">attr</span> <span class="o">is</span> <span class="s1">&#39;value&#39;</span>
          <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">change</span> <span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span>
            <span class="nv">value = </span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span>
            <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;false&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">false</span>
            <span class="k">if</span> <span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;true&#39;</span> <span class="k">then</span> <span class="nv">value = </span><span class="kc">true</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>
    
    <span class="nv">context: </span><span class="nf">(node, contextName, key, contexts) -&gt;</span>
      <span class="nv">context = </span><span class="nx">matchContext</span><span class="p">(</span><span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
      <span class="nv">object = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
      <span class="nx">object</span><span class="p">[</span><span class="nx">contextName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span>
      
      <span class="nx">contexts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">object</span>
      
      <span class="nv">node.onParseExit = </span><span class="o">-&gt;</span>
        <span class="nv">index = </span><span class="nx">contexts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
        <span class="nx">contexts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">contexts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">index</span><span class="p">)</span>
    
    <span class="nv">event: </span><span class="nf">(node, eventName, key, contexts) -&gt;</span>
      <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;@&#39;</span>
        <span class="nv">callback = </span><span class="k">new</span> <span class="nb">Function</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
        <span class="nv">callback = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span>
      
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="nx">node</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nv">confirmText = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-confirm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">confirmText</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">confirm</span><span class="p">(</span><span class="nx">confirmText</span><span class="p">)</span>
          <span class="k">return</span>
        
        <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">arguments</span>
    
    <span class="nv">addclass: </span><span class="nf">(node, className, key, contexts, parentRenderer, invert) -&gt;</span>
      <span class="nv">className = </span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\|/g</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1">#this will let you add or remove multiple class names in one binding</span>
      
      <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">observe</span> <span class="nx">key</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="nf">(value) -&gt;</span>
        <span class="nv">currentName = </span><span class="nx">node</span><span class="p">.</span><span class="nx">className</span>
        <span class="nv">includesClassName = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="o">!!</span><span class="nx">value</span> <span class="o">is</span> <span class="o">!</span><span class="nx">invert</span>
          <span class="nv">node.className = </span><span class="s2">&quot;#{currentName} #{className}&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="nx">includesClassName</span>
        <span class="k">else</span>
          <span class="nv">node.className = </span><span class="nx">currentName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">className</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">includesClassName</span>
          
    <span class="nv">removeclass: </span><span class="nf">(args...) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">attrReaders</span><span class="p">.</span><span class="nx">addclass</span> <span class="nx">args</span><span class="p">...,</span> <span class="kc">yes</span>
    
    <span class="nv">foreach: </span><span class="nf">(node, iteratorName, key, contexts, parentRenderer) -&gt;</span>
      <span class="nv">prototype = </span><span class="nx">node</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
      <span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="s2">&quot;data-foreach-#{iteratorName}&quot;</span>
      
      <span class="nv">parent = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>
      
      <span class="nv">nodeMap = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Hash</span>
      
      <span class="nv">contextsClone = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">contexts</span><span class="p">)</span>
      <span class="nv">context = </span><span class="nx">matchContext</span> <span class="nx">contexts</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nv">collection = </span><span class="nx">context</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span>
      
      <span class="k">if</span> <span class="nx">collection</span><span class="o">?</span><span class="p">.</span><span class="nx">observe</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="nv">add = </span><span class="nf">(item) -&gt;</span>
          <span class="nv">newNode = </span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
          <span class="nx">nodeMap</span><span class="p">.</span><span class="nx">set</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">newNode</span>
          
          <span class="nv">renderer = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Renderer</span> <span class="nx">newNode</span><span class="p">,</span> <span class="o">-&gt;</span>
            <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">newNode</span>
            <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">allow</span> <span class="s1">&#39;ready&#39;</span>
          
          <span class="nv">renderer.contexts = localClone = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">contextsClone</span><span class="p">)</span>
          <span class="nv">renderer.contextObject = </span><span class="nx">Batman</span> <span class="nx">localClone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          
          <span class="nv">iteratorContext = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span>
          <span class="nx">iteratorContext</span><span class="p">[</span><span class="nx">iteratorName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span>
          <span class="nx">localClone</span><span class="p">.</span><span class="nx">push</span> <span class="nx">iteratorContext</span>
          <span class="nx">localClone</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
        
        <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="nv">remove = </span><span class="nf">(item) -&gt;</span>
          <span class="nv">oldNode = </span><span class="nx">nodeMap</span><span class="p">.</span><span class="nx">get</span> <span class="nx">item</span>
          <span class="nx">oldNode</span><span class="o">?</span><span class="p">.</span><span class="nx">parentNode</span><span class="o">?</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">oldNode</span>
        
        <span class="nx">collection</span><span class="p">.</span><span class="nx">observe</span> <span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">each</span> <span class="nx">remove</span>
          <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">each</span> <span class="nx">add</span><span class="p">),</span> <span class="mi">0</span>
        
        <span class="nx">collection</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(item) -&gt;</span>
          <span class="nx">parentRenderer</span><span class="p">.</span><span class="nx">prevent</span> <span class="s1">&#39;ready&#39;</span>
          <span class="nx">add</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
      
      <span class="kc">false</span>
  <span class="p">}</span>

  </pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p><code>Batman.DOM.events</code> contains the helpers used for binding to events. These aren't called by
DOM directives, but are used to handle specific events by the <code>data-event-#{name}</code> helper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">events: </span><span class="p">{</span>
    <span class="nv">click: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      
      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;A&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span>
        <span class="nv">node.href = </span><span class="s1">&#39;#&#39;</span>
    
    <span class="nv">change: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="nv">eventName = </span><span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="k">when</span> <span class="s1">&#39;TEXTAREA&#39;</span> <span class="k">then</span> <span class="s1">&#39;keyup&#39;</span>
        <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span>
          <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;TEXT&#39;</span> <span class="k">then</span> <span class="s1">&#39;keyup&#39;</span> <span class="k">else</span> <span class="s1">&#39;change&#39;</span>
        <span class="k">else</span> <span class="s1">&#39;change&#39;</span>
      
      <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span>
    
    <span class="nv">submit: </span><span class="nf">(node, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">nodeIsEditable</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
          <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">is</span> <span class="mi">13</span>
            <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">node</span><span class="p">,</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
          <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">arguments</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p><code>yield</code> and <code>contentFor</code> are used to declare partial views and then pull them in elsewhere.
This can be used for abstraction as well as repetition.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">yield: </span><span class="nf">(name, node) -&gt;</span>
    <span class="nv">yields = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">yields</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nv">content = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span><span class="o">?</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
      <span class="nv">node.innerHTML = </span><span class="s1">&#39;&#39;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="k">if</span> <span class="nx">content</span>
  
  <span class="nv">contentFor: </span><span class="nf">(name, node) -&gt;</span>
    <span class="nv">contents = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yieldContents</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="nx">contents</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nv">yield = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">_yields</span><span class="o">?</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>
      <span class="nv">yield.innerHTML = </span><span class="s1">&#39;&#39;</span>
      <span class="nx">yield</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">if</span> <span class="nx">node</span>
  
  <span class="nv">valueForNode: </span><span class="nf">(node, value) -&gt;</span>
    <span class="nv">isSetting = </span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    
    <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
      <span class="k">when</span> <span class="s1">&#39;INPUT&#39;</span> <span class="k">then</span> <span class="p">(</span><span class="k">if</span> <span class="nx">isSetting</span> <span class="k">then</span> <span class="p">(</span><span class="nv">node.value = </span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">else</span> <span class="p">(</span><span class="k">if</span> <span class="nx">isSetting</span> <span class="k">then</span> <span class="p">(</span><span class="nv">node.innerHTML = </span><span class="nx">value</span><span class="p">)</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
  
  <span class="nv">nodeIsEditable: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXTAREA&#39;</span><span class="p">]</span>
  
  <span class="nv">addEventListener: </span><span class="nf">(node, eventName, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span>
    <span class="k">else</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="s2">&quot;on#{eventName}&quot;</span><span class="p">,</span> <span class="nx">callback</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <h2>Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">camelize_rx = </span><span class="sr">/(?:^|_)(.)/g</span>
<span class="nv">underscore_rx1 = </span><span class="sr">/([A-Z]+)([A-Z][a-z])/g</span>
<span class="nv">underscore_rx2 = </span><span class="sr">/([a-z\d])([A-Z])/g</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Just a few random Rails-style string helpers. You can add more
to the Batman.helpers object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">helpers = Batman.helpers = </span><span class="p">{</span>
  <span class="nv">camelize: </span><span class="nf">(string, firstLetterLower) -&gt;</span>
    <span class="nv">string = </span><span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">camelize_rx</span><span class="p">,</span> <span class="nf">(str, p1) -&gt;</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">firstLetterLower</span> <span class="k">then</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nx">string</span>

  <span class="nv">underscore: </span><span class="nf">(string) -&gt;</span>
    <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx1</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">underscore_rx2</span><span class="p">,</span> <span class="s1">&#39;$1_$2&#39;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">singularize: </span><span class="nf">(string) -&gt;</span>
    <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;s&#39;</span>
      <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">string</span>

  <span class="nv">pluralize: </span><span class="nf">(count, string) -&gt;</span>
    <span class="k">if</span> <span class="nx">string</span>
      <span class="k">return</span> <span class="nx">string</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nv">string = </span><span class="nx">count</span>

    <span class="k">if</span> <span class="nx">string</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;y&#39;</span>
      <span class="s2">&quot;#{string.substr(0,string.length-1)}ies&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;#{string}s&quot;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <h2>Filters</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">filters = Batman.filters = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <h2>Mixins</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mixins = Batman.mixins = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nb">Object</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Export a few globals, and grab a reference to an object accessible from all contexts for use elsewhere.
In node, the container is the <code>global</code> object, and in the browser, the container is the window object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">container = </span><span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nv">exports.Batman = </span><span class="nx">Batman</span>
  <span class="nx">global</span>
<span class="k">else</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">Batman = </span><span class="nx">Batman</span>
  <span class="nb">window</span>

<span class="nx">$mixin</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Observable</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Optionally export global sugar. Not sure what to do with this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Batman.exportHelpers = </span><span class="nf">(onto) -&gt;</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$typeOf = </span><span class="nx">$typeOf</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$mixin = </span><span class="nx">$mixin</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$unmixin = </span><span class="nx">$unmixin</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$route = </span><span class="nx">$route</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$redirect = </span><span class="nx">$redirect</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$event = </span><span class="nx">$event</span>
  <span class="nx">onto</span><span class="p">.</span><span class="nv">$eventOneShot = </span><span class="nx">$eventOneShot</span>

<span class="nv">Batman.exportGlobals = </span><span class="nf">() -&gt;</span>
  <span class="nx">Batman</span><span class="p">.</span><span class="nx">exportHelpers</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 